import json
import os

# Função para limpar a tela
def limpar_tela():
    os.system('cls' if os.name == 'nt' else 'clear')

# Função para exibir o menu de bebidas
def mostrar_menu():
    print("\nBem-vindo à distribuidora!")
    print("Escolha uma das bebidas abaixo:")
    bebidas = {
        "1": {"nome": "Cerveja", "preco": 5.00},
        "2": {"nome": "Refrigerante", "preco": 3.00},
        "3": {"nome": "Água", "preco": 2.00},
        "4": {"nome": "Suco", "preco": 4.50},
        "5": {"nome": "Vinho", "preco": 20.00}
    }
    for key, bebida in bebidas.items():
        print(f"{key}. {bebida['nome']} - R$ {bebida['preco']:.2f}")
    return bebidas

# Função para salvar usuários
def salvar_usuarios(usuarios):
    with open('usuarios.json', 'w') as file:
        json.dump(usuarios, file, indent=4)

# Função para carregar usuários
def carregar_usuarios():
    try:
        with open('usuarios.json', 'r') as file:
            return json.load(file)
    except FileNotFoundError:
        return {}

# Função para cadastrar novo usuário com senha
def cadastrar_usuario(usuarios):
    username = input("Escolha um nome de usuário: ").strip()
    if username in usuarios:
        print("Usuário já existe. Tente outro nome.")
        return None
    senha = input("Escolha uma senha: ").strip()
    # Não inicializa saldo, o usuário começará com saldo zerado.
    usuarios[username] = {"senha": senha, "pedidos": []}
    salvar_usuarios(usuarios)
    print(f"Usuário {username} cadastrado com sucesso! Seu saldo inicial é de R$ 0,00.")
    return username

# Função para login de usuário com verificação de senha
def login_usuario(usuarios):
    username = input("Digite seu nome de usuário: ").strip()
    if username in usuarios:
        senha = input("Digite sua senha: ").strip()
        if senha == usuarios[username]['senha']:
            print(f"Login bem-sucedido! Seu saldo atual é de R$ 0,00")
            return username
        else:
            print("Senha incorreta. Tente novamente.")
            return None
    else:
        print("Usuário não encontrado. Tente novamente ou cadastre-se.")
        return None

# Função para processar o pagamento
def realizar_pagamento(total_pedido, saldo_usuario):
    print(f"\nTotal do pedido: R$ {total_pedido:.2f}")
    print(f"Seu saldo atual é R$ {saldo_usuario:.2f}")

    while True:
        confirmar = input("Deseja confirmar o pagamento? (s/n): ").lower()
        if confirmar == 's':
            if total_pedido > saldo_usuario:
                print("Saldo insuficiente para realizar o pagamento!")
                return False
            else:
                print("Pagamento confirmado!")
                return True
        elif confirmar == 'n':
            print("Pagamento cancelado.")
            return False
        else:
            print("Opção inválida. Tente novamente.")

# Função para fazer um pedido
def fazer_pedido(usuarios, username):
    saldo_usuario = 0.0  # O saldo é considerado zerado até que o usuário deposite.
    while True:
        bebidas = mostrar_menu()
        pedido = []

        while True:
            escolha = input("\nDigite o número da bebida desejada (ou '0' para finalizar o pedido): ")

            if escolha == '0':
                break
            elif escolha in bebidas:
                qtd = int(input(f"Quantas unidades de {bebidas[escolha]['nome']}? "))
                total_item = bebidas[escolha]['preco'] * qtd
                bebida_escolhida = {
                    "nome": bebidas[escolha]["nome"],
                    "preco_unitario": bebidas[escolha]["preco"],
                    "quantidade": qtd,
                    "total": total_item
                }
                pedido.append(bebida_escolhida)
                print(f"{bebidas[escolha]['nome']} adicionado ao pedido. Total parcial: R$ {total_item:.2f}")
            else:
                print("Escolha inválida. Tente novamente.")

        if pedido:
            total_pedido = sum(item['total'] for item in pedido)
            if realizar_pagamento(total_pedido, saldo_usuario):
                print("\nPedido finalizado com sucesso!")
                # Aqui poderia incluir uma lógica para o saldo, se o usuário realizar um depósito.
                break
            else:
                print("\nO pedido foi cancelado.")
                break
        else:
            print("\nNenhuma bebida foi selecionada.")

# Função para realizar um depósito
def realizar_deposito(usuarios, username):
    while True:
        try:
            valor = float(input("Digite o valor que deseja depositar: R$ "))
            if valor > 0:
                # Para fins de simplicidade, atualiza o saldo diretamente no usuário.
                usuarios[username]['saldo'] = usuarios.get(username, {}).get('saldo', 0) + valor
                salvar_usuarios(usuarios)
                print(f"Depósito de R$ {valor:.2f} realizado com sucesso! Seu novo saldo é R$ {usuarios[username]['saldo']:.2f}.")
                break
            else:
                print("O valor deve ser maior que zero. Tente novamente.")
        except ValueError:
            print("Entrada inválida. Digite um número válido.")

# Função principal para gerenciar cadastro, login e pedidos
def distribuidora():
    usuarios = carregar_usuarios()
    username = None

    while not username:
        limpar_tela()
        print("Bem-vindo à distribuidora!")
        print("1. Cadastrar novo usuário")
        print("2. Fazer login")
        escolha = input("Escolha uma opção: ")

        if escolha == '1':
            username = cadastrar_usuario(usuarios)
        elif escolha == '2':
            username = login_usuario(usuarios)
        else:
            print("Opção inválida. Tente novamente.")

    while True:
        limpar_tela()
        print("Menu de opções:")
        print("1. Fazer pedido")
        print("2. Realizar depósito")
        print("3. Sair")
        escolha = input("Escolha uma opção: ")

        if escolha == '1':
            fazer_pedido(usuarios, username)
        elif escolha == '2':
            realizar_deposito(usuarios, username)
        elif escolha == '3':
            print("Obrigado por comprar na nossa distribuidora!")
            break
        else:
            print("Opção inválida. Tente novamente.")

# Executa o sistema da distribuidora
distribuidora()

